{{- if .Values.migration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "microservice.fullname" . }}-migrate
  labels:
    {{- include "microservice.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "microservice.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      restartPolicy: OnFailure
      {{- with .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: merge-config-and-secrets
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              set -e
              OUT="{{ .Values.configVolume.mountPath }}/{{ .Values.configVolume.envFilePath }}"
              mkdir -p "$(dirname "$OUT")"
              touch "$OUT"
              chmod 600 "$OUT"
              if [ -d /shared-config ]; then
                for f in /shared-config/*; do
                  [ -f "$f" ] && echo "$(basename "$f")=$(cat "$f")" >> "$OUT"
                done
              fi
              if [ -d /service-config ]; then
                for f in /service-config/*; do
                  [ -f "$f" ] && echo "$(basename "$f")=$(cat "$f")" >> "$OUT"
                done
              fi
              if [ -d /app-secrets ]; then
                for f in /app-secrets/*; do
                  [ -f "$f" ] && echo "$(basename "$f")=$(cat "$f")" >> "$OUT"
                done
              fi
              echo "Merged config and secrets into $OUT"
          volumeMounts:
            - name: shared-config
              mountPath: /shared-config
              readOnly: true
            - name: env-file
              mountPath: "{{ .Values.configVolume.mountPath }}"
            {{- if .Values.existingConfigMap }}
            - name: service-config
              mountPath: /service-config
              readOnly: true
            {{- end }}
            - name: app-secrets
              mountPath: /app-secrets
              readOnly: true
      containers:
        - name: migrate
          {{- $repo := .Values.image.repository | default .Values.imageRepository }}
          image: "{{ if $repo }}{{ $repo }}/{{ end }}{{ .Values.image.name }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: {{- toYaml .Values.migration.command | nindent 12 }}
          env:
            - name: DOTENV_CONFIG_PATH
              value: "{{ .Values.configVolume.mountPath }}/{{ .Values.configVolume.envFilePath }}"
            {{- with .Values.env }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          volumeMounts:
            - name: env-file
              mountPath: "{{ .Values.configVolume.mountPath }}"
              readOnly: true
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: shared-config
          configMap:
            name: global-shared-config
        - name: env-file
          emptyDir: {}
        {{- if .Values.existingConfigMap }}
        - name: service-config
          configMap:
            name: {{ .Values.existingConfigMap }}
        {{- end }}
        - name: app-secrets
          {{- if eq .Values.secretsVolume.type "csi" }}
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: {{ .Values.secretsVolume.csi.secretProviderClass | quote }}
          {{- else }}
          secret:
            secretName: {{ .Values.secretsVolume.secretName | default .Values.existingSecret | default (printf "%s-secrets" (include "microservice.fullname" .)) }}
          {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
