# Users service (GraphQL). Convention: protocol=http -> port 3000/80.
# Config keys from apps/users-service/.env.example
# Install: helm install users-graphql charts/microservice -f values/cluster.yaml -f values/users-service/users-graphql.yaml -n <ns>

fullnameOverride: users-graphql
component: graphql

portEnvKey: APP_GRAPHQL_PORT

image:
  name: users-service
  tag: latest
  pullPolicy: IfNotPresent

command: ["node", "dist/graphql.main"]

dependencies:
  - service: users-grpc

env:
  - name: APP_NAME
    value: "users-service"

secretKeys:
  - USERS_SERVICE_GRAPHQL_URL
  - USERS_SERVICE_GRPC_URL
  - INTERNAL_REGISTRY_SERVER_HOST
  - DB_CONNECTION_URL

existingSecret: users-graphql-service-config

resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

replicaCount: 1

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

service:
  type: ClusterIP

# NetworkPolicy: allow traffic from api-gateway-graphql, egress to users-grpc.
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: gateway
      ports:
        - port: 80
          protocol: TCP
  egress:
    # Allow to all gRPC services
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: grpc
      ports:
        - port: 5000
          protocol: TCP
    # Allow to registry (service discovery)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: registry
      ports:
        - port: 80
          protocol: TCP
