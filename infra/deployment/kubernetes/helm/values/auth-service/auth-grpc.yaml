# Auth service (gRPC). Convention: protocol=grpc -> port 5000.
# Config keys from apps/auth-service/.env.example
# Install: helm install auth-grpc charts/microservice -f values/cluster.yaml -f values/auth-service/auth-grpc.yaml -n <ns>

fullnameOverride: auth-grpc
component: grpc

protocol: grpc

image:
  name: auth-service
  tag: latest
  pullPolicy: IfNotPresent

command: ["node", "dist/grpc.main"]

dependencies:
  - service: users-grpc
  - service: registry

# Service-specific env only; NODE_ENV, LOG_LEVEL, etc. from global-shared-config.
env:
  - name: APP_NAME
    value: "auth-service"
  - name: AUTH_SERVICE_GRAPHQL_URL
    value: "http://auth-graphql:80"
  - name: AUTH_SERVICE_GRPC_URL
    value: "auth-grpc:5000"
  - name: INTERNAL_REGISTRY_SERVER_HOST
    value: "http://registry:80"

secretKeys:
  - DB_CONNECTION_URL
  - AT_SECRET
  - RT_SECRET
  - COOKIES_MAX_AGE

existingSecret: auth-grpc-service-config

# AWS CSI: SecretProviderClass name (applied when secretsVolume.type=csi via values/aws.yaml)
secretsVolume:
  csi:
    secretProviderClass: auth-service-secrets

resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

replicaCount: 1

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

service:
  type: ClusterIP

# NetworkPolicy: allow traffic from auth-graphql, egress to external DB + registry + users-grpc.
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: graphql
      ports:
        - port: 5000
          protocol: TCP
  egress:
    # Allow to other gRPC services (inter-service communication)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: grpc
      ports:
        - port: 5000
          protocol: TCP
    # Allow to registry (service discovery)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: registry
      ports:
        - port: 80
          protocol: TCP
    # Allow to external database (all external IPs)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 5432
          protocol: TCP
